# {{ ansible_managed }}
# Do not edit this file by hand.  Your changes will be overwritten
# Use TSstaticip tool, or the TS network configuration page
#
# If em1 or em2 interfaces are also available, they will be configured
# as DHCP but not activated automatically
#
# If eth2 (tapped to WAN) is available, they will be configured
# as DHCP but not activated automatically. Static IP will be
# setup manually in all_local.

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto {{default_interface}}
{% if S5_virtual_guest|bool or STATIC_IP|bool %}
iface {{default_interface}} inet static
    address {{static_ip}}
    netmask {{static_nm}}
    gateway {{static_gw}}
{% if dns_search|default(false) %}
    dns-search {{dns_search}}
{%endif%}
{% if dns_nameserver|default(false) %}
    dns-nameservers {{dns_nameserver}}
{%else%}
{%endif%}
{% else %}
iface {{ default_interface }} inet dhcp
{% endif %}
{% if config_firewall|bool %}
    pre-up iptables-restore < /etc/iptables.rules
    pre-up iptables-restore --noflush < /etc/iptables.custom

{% endif %}
{# Configure NIC port with internal network #}
{% for interface in ansible_interfaces|sort if ('eth' in interface or interface[0] == 'p') and interface != default_interface %}
{# S5 TSVM eth2 is tap interface to WAN port of instrument #}
{% if S5_virtual_guest|bool and ('eth2' in interface)  %}
{% if enable_tap_interface|bool %}
auto {{ interface }}
{% else %}
# auto {{ interface }}
{% endif %}
{% if TAP_STATIC_IP|bool %}
iface {{ interface }} inet static
    address {{ tap_static_ip }}
    netmask {{ tap_static_nm }}
    gateway {{ tap_static_gw }}
{% if tap_dns_search|default(false) %}
    dns-search {{ tap_dns_search }}
{% endif %}
{% if tap_dns_nameserver|default(false) %}
    dns-nameservers {{ tap_dns_nameserver }}
{% endif %}
{% else %}
{# not static or required fields not present #}
iface {{ interface }} inet dhcp
{% endif %}
{% else %}
{# regular NIC port to be configured as instrument ports #}
auto {{ interface }}
iface {{ interface }} inet static
address {{ b_subnet }}.{{ loop.index + class_c }}.1
netmask 255.255.255.0
{% endif %}

{% endfor %}
{# Configure em1 and em2 as dhcp #}
{% for interface in ansible_interfaces if 'em' in interface and interface != default_interface %}
#auto {{interface}}
iface {{interface}} inet dhcp

{% endfor %}
# the end
